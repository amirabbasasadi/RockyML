\hypertarget{scontainer_8h_source}{}\doxysection{scontainer.\+h}
\label{scontainer_8h_source}\index{include/rocky/zagros/containers/scontainer.h@{include/rocky/zagros/containers/scontainer.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{    Copyright (C) 2022 Amirabbas Asadi , All Rights Reserved}}
\DoxyCodeLine{3 \textcolor{comment}{    distributed under Apache-\/2.0 license}}
\DoxyCodeLine{4 \textcolor{comment}{*/}}
\DoxyCodeLine{5 \textcolor{preprocessor}{\#ifndef ROCKY\_ZAGROS\_SCONTAINER\_GUARD}}
\DoxyCodeLine{6 \textcolor{preprocessor}{\#define ROCKY\_ZAGROS\_SCONTAINER\_GUARD}}
\DoxyCodeLine{7 }
\DoxyCodeLine{8 }
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include<iostream>}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include<cmath>}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include<utility>}}
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include<memory>}}
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include<limits>}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include<random>}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include<vector>}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#include<set>}}
\DoxyCodeLine{17 }
\DoxyCodeLine{18 \textcolor{preprocessor}{\#include<tbb/tbb.h>}}
\DoxyCodeLine{19 \textcolor{preprocessor}{\#include<Eigen/Core>}}
\DoxyCodeLine{20 }
\DoxyCodeLine{21 \textcolor{preprocessor}{\#include<rocky/zagros/system.h>}}
\DoxyCodeLine{22 \textcolor{preprocessor}{\#include<rocky/utils.h>}}
\DoxyCodeLine{23 }
\DoxyCodeLine{24 \textcolor{keyword}{namespace }rocky\{}
\DoxyCodeLine{25 \textcolor{keyword}{namespace }zagros\{}
\DoxyCodeLine{30 \textcolor{keyword}{template}<\textcolor{keyword}{typename} T\_e, \textcolor{keywordtype}{int} T\_dim>}
\DoxyCodeLine{31 \textcolor{keyword}{class }\mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer}{basic\_scontainer}}\{}
\DoxyCodeLine{32 \textcolor{keyword}{protected}:}
\DoxyCodeLine{33     \textcolor{keywordtype}{int} n\_particles\_;}
\DoxyCodeLine{34     \textcolor{keywordtype}{int} group\_size\_;}
\DoxyCodeLine{35 \textcolor{keyword}{public}:}
\DoxyCodeLine{36     \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer}{basic\_scontainer}}(\textcolor{keywordtype}{int} n\_particles, \textcolor{keywordtype}{int} group\_size)\{}
\DoxyCodeLine{37         n\_particles\_ = n\_particles;}
\DoxyCodeLine{38         group\_size\_ = group\_size;}
\DoxyCodeLine{39     \}}
\DoxyCodeLine{40     \textcolor{keywordtype}{int} n\_particles()\textcolor{keyword}{ const}\{}
\DoxyCodeLine{41         \textcolor{keywordflow}{return} n\_particles\_;}
\DoxyCodeLine{42     \}}
\DoxyCodeLine{43     \textcolor{keywordtype}{int} group\_size()\textcolor{keyword}{ const}\{}
\DoxyCodeLine{44         \textcolor{keywordflow}{return} group\_size\_;}
\DoxyCodeLine{45     \}}
\DoxyCodeLine{46     \textcolor{keywordtype}{int} n\_groups()\textcolor{keyword}{ const}\{}
\DoxyCodeLine{47         \textcolor{keywordflow}{return} n\_particles() / group\_size();}
\DoxyCodeLine{48     \}}
\DoxyCodeLine{49     \textcolor{comment}{// holding particles}}
\DoxyCodeLine{50     std::vector<std::vector<T\_e>> particles;}
\DoxyCodeLine{51     \textcolor{comment}{// holding the particles value}}
\DoxyCodeLine{52     std::vector<T\_e> values;}
\DoxyCodeLine{53     \textcolor{keywordtype}{void} reset\_values()\{}
\DoxyCodeLine{54         \textcolor{comment}{// initialize particles value}}
\DoxyCodeLine{55         std::fill(values.begin(), values.end(), std::numeric\_limits<T\_e>::max());}
\DoxyCodeLine{56     \}}
\DoxyCodeLine{57     \textcolor{comment}{// allocate the requred memory}}
\DoxyCodeLine{58     \textcolor{keywordtype}{void} allocate()\{}
\DoxyCodeLine{59         particles.resize(n\_particles());}
\DoxyCodeLine{60         \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} p=0; p<n\_particles(); ++p)}
\DoxyCodeLine{61             particles[p].resize(T\_dim);}
\DoxyCodeLine{62         values.resize(n\_particles());}
\DoxyCodeLine{63         reset\_values();}
\DoxyCodeLine{64     \}}
\DoxyCodeLine{71     T\_e* \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_ab608784fc75d08bba940962dfd5761b5}{particle}}(\textcolor{keywordtype}{int} p)\{}
\DoxyCodeLine{72         \textcolor{keywordflow}{return} particles[p].data();}
\DoxyCodeLine{73     \}}
\DoxyCodeLine{80     \textcolor{keywordtype}{int} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a22445f9bfd490ff15db90355ac38bd56}{particle\_group}}(\textcolor{keywordtype}{int} p)\{}
\DoxyCodeLine{81         \textcolor{keywordflow}{return} p / group\_size();}
\DoxyCodeLine{82     \}}
\DoxyCodeLine{89     T\_e* \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a219a79dfe13dbd170d293dab9c543f0a}{group}}(\textcolor{keywordtype}{int} g)\{}
\DoxyCodeLine{90         \textcolor{keywordflow}{return} particles[g * group\_size()].data();}
\DoxyCodeLine{91     \}}
\DoxyCodeLine{98     std::pair<int, int> \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a23a4f83d33ad22684baf2773a158d463}{group\_range}}(\textcolor{keywordtype}{int} g)\textcolor{keyword}{ const}\{}
\DoxyCodeLine{99         \textcolor{keywordtype}{int} group\_s = g * group\_size();}
\DoxyCodeLine{100         \textcolor{keywordtype}{int} group\_e = group\_s + group\_size();}
\DoxyCodeLine{101         \textcolor{keywordflow}{if} (g == n\_groups() -\/ 1)}
\DoxyCodeLine{102             group\_e = n\_particles();}
\DoxyCodeLine{103         \textcolor{keywordflow}{return} std::make\_pair(group\_s, group\_e);            }
\DoxyCodeLine{104     \}}
\DoxyCodeLine{110     T\_e* \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a2e57930a0301bbd6acb861ac6271339c}{value}}(\textcolor{keywordtype}{int} p)\{}
\DoxyCodeLine{111         \textcolor{keywordflow}{return} \&values[p];}
\DoxyCodeLine{112     \}}
\DoxyCodeLine{119     \textcolor{keywordtype}{void} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a06c313144e43da64b42cb2d891d2859c}{sample\_n\_particles}}(\textcolor{keywordtype}{int}* indices, \textcolor{keywordtype}{int} n=1)\{}
\DoxyCodeLine{120         \textcolor{keyword}{auto} weighted\_dist = \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a7fa9d1f300c7141e87d85ebaee81f6af}{weighted\_sampler}}();}
\DoxyCodeLine{121         std::set<int> indices\_set;}
\DoxyCodeLine{122         \textcolor{keywordtype}{int} max\_iters = 10 * n;}
\DoxyCodeLine{123         \textcolor{keywordtype}{int} iters = 0;}
\DoxyCodeLine{124         \textcolor{keywordflow}{do}\{}
\DoxyCodeLine{125             indices\_set.insert(weighted\_dist(rocky::utils::random::prng()));}
\DoxyCodeLine{126             iters++;}
\DoxyCodeLine{127         \} \textcolor{keywordflow}{while}((indices\_set.size() < n) \&\& (iters < max\_iters));}
\DoxyCodeLine{128 }
\DoxyCodeLine{129         \textcolor{keywordflow}{if}(indices\_set.size() < n)\{}
\DoxyCodeLine{130             std::uniform\_int\_distribution uniform\_dist(0, n\_particles()-\/1);}
\DoxyCodeLine{131             \textcolor{keywordflow}{do}\{}
\DoxyCodeLine{132                 indices\_set.insert(uniform\_dist(rocky::utils::random::prng()));}
\DoxyCodeLine{133             \}\textcolor{keywordflow}{while}(indices\_set.size() < n);}
\DoxyCodeLine{134         \}}
\DoxyCodeLine{135         \textcolor{keywordtype}{int} i = 0;}
\DoxyCodeLine{136         \textcolor{keywordflow}{for}(\textcolor{keyword}{auto} index: indices\_set)}
\DoxyCodeLine{137             indices[i++] = index;}
\DoxyCodeLine{138     \}    }
\DoxyCodeLine{145     std::pair<int, int> \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_ae6a089a00a0940169bbc821d707eba20}{sample\_pair}}(\textcolor{keywordtype}{int} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a219a79dfe13dbd170d293dab9c543f0a}{group}})\{}
\DoxyCodeLine{146         \textcolor{keyword}{auto} indices = \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a06c313144e43da64b42cb2d891d2859c}{sample\_n\_particles}}(2, \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a219a79dfe13dbd170d293dab9c543f0a}{group}});}
\DoxyCodeLine{147         \textcolor{keyword}{auto} el = indices.begin();}
\DoxyCodeLine{148         \textcolor{keyword}{auto} result = std::make\_pair(*el, *(std::next(el)));}
\DoxyCodeLine{149         \textcolor{keywordflow}{return} result;}
\DoxyCodeLine{150     \}}
\DoxyCodeLine{157     \textcolor{keywordtype}{int} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a2d68c91514a4d35a4233690941bca6cf}{sample\_particle}}(\textcolor{keywordtype}{int} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a219a79dfe13dbd170d293dab9c543f0a}{group}})\{}
\DoxyCodeLine{158         \textcolor{keyword}{auto} group\_rng = \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a23a4f83d33ad22684baf2773a158d463}{group\_range}}(\mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a219a79dfe13dbd170d293dab9c543f0a}{group}});}
\DoxyCodeLine{159         std::uniform\_int\_distribution<> dist(group\_rng.first, group\_rng.second-\/1);}
\DoxyCodeLine{160         \textcolor{keywordflow}{return} dist(rocky::utils::random::prng());}
\DoxyCodeLine{161     \}}
\DoxyCodeLine{167     \textcolor{keywordtype}{int} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_ad950c381f255096ae5a35d86acb515ed}{sample\_dim}}()\{}
\DoxyCodeLine{168         std::uniform\_int\_distribution<> dist(0, T\_dim-\/1);}
\DoxyCodeLine{169         \textcolor{keywordflow}{return} dist(rocky::utils::random::prng());}
\DoxyCodeLine{170     \}  }
\DoxyCodeLine{175     \textcolor{keywordtype}{size\_t} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a7f7d6646b77dd811aebba0832f18a344}{space}}()\textcolor{keyword}{ const}\{}
\DoxyCodeLine{176         \textcolor{keywordflow}{return} \textcolor{keyword}{sizeof}(T\_e) * (n\_particles() * (T\_dim + 1));}
\DoxyCodeLine{177     \}}
\DoxyCodeLine{182      T\_e \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_ac2a40d121ffe0ac18cfe3d24aecdcdcd}{best\_min}}()\{}
\DoxyCodeLine{183         T\_e best = *std::min\_element(values.begin(), values.end());}
\DoxyCodeLine{184         \textcolor{keywordflow}{return} best;}
\DoxyCodeLine{185      \}}
\DoxyCodeLine{191      std::pair<T\_e, int> \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a1685d2f27def218f910d216c7afe5da8}{best\_min\_index}}()\{}
\DoxyCodeLine{192         \textcolor{keyword}{auto} min\_el = std::min\_element(values.begin(), values.end());}
\DoxyCodeLine{193         \textcolor{keywordtype}{int} index = \textcolor{keyword}{static\_cast<}\textcolor{keywordtype}{int}\textcolor{keyword}{>}(min\_el -\/ values.begin());}
\DoxyCodeLine{194         T\_e best = *min\_el;}
\DoxyCodeLine{195         \textcolor{keywordflow}{return} std::make\_pair(best, index);}
\DoxyCodeLine{196      \}}
\DoxyCodeLine{205      \textcolor{keywordtype}{void} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a8566e2a8a6419f5c5ba60986855b5c0d}{evaluate\_and\_update}}(\mbox{\hyperlink{classrocky_1_1zagros_1_1system}{system<T\_e>}}* problem, \textcolor{keywordtype}{int} rng\_start, \textcolor{keywordtype}{int} rng\_end)\{}
\DoxyCodeLine{206         tbb::parallel\_for(rng\_start, rng\_end, [\&](\textcolor{keywordtype}{int} p)\{}
\DoxyCodeLine{207             T\_e obj = problem-\/>objective(this-\/>\mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_ab608784fc75d08bba940962dfd5761b5}{particle}}(p));}
\DoxyCodeLine{208             this-\/>values[p] = obj;        }
\DoxyCodeLine{209         \});}
\DoxyCodeLine{210      \}}
\DoxyCodeLine{218      \textcolor{keywordtype}{void} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a1119fc8e0091b819c7bb478da92a6ee1}{evaluate\_and\_update}}(\mbox{\hyperlink{classrocky_1_1zagros_1_1system}{system<T\_e>}}* problem, \textcolor{keywordtype}{int} p)\{}
\DoxyCodeLine{219         \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a8566e2a8a6419f5c5ba60986855b5c0d}{evaluate\_and\_update}}(problem, p, p+1);}
\DoxyCodeLine{220      \}}
\DoxyCodeLine{227      \textcolor{keywordtype}{void} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a112e6c1cfd32b10e5029fe6daac4ba2a}{evaluate\_and\_update}}(\mbox{\hyperlink{classrocky_1_1zagros_1_1system}{system<T\_e>}}* problem)\{}
\DoxyCodeLine{228         \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a8566e2a8a6419f5c5ba60986855b5c0d}{evaluate\_and\_update}}(problem, 0, n\_particles());}
\DoxyCodeLine{229      \}}
\DoxyCodeLine{236      \textcolor{keywordtype}{void} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_aa1b9205c60b64912103c0d79cf164e70}{best\_k}}(\textcolor{keywordtype}{int}* indices, \textcolor{keywordtype}{int} k)\{}
\DoxyCodeLine{237         \textcolor{keyword}{auto} comp\_values = [\textcolor{keyword}{this}](\textcolor{keywordtype}{int} x, \textcolor{keywordtype}{int} y)\{}
\DoxyCodeLine{238             \textcolor{keywordflow}{return} this-\/>values[x] < this-\/>values[y];}
\DoxyCodeLine{239         \};}
\DoxyCodeLine{240         std::vector<int> all\_ind(n\_particles());}
\DoxyCodeLine{241         std::iota(all\_ind.begin(), all\_ind.end(), 0);}
\DoxyCodeLine{242         std::sort(all\_ind.begin(), all\_ind.end(), comp\_values);}
\DoxyCodeLine{243         std::copy(all\_ind.data(), all\_ind.data()+k, indices);   }
\DoxyCodeLine{244      \}}
\DoxyCodeLine{251      \textcolor{keywordtype}{void} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_aafc170ddfcde8fa6b8f0d763fb327ef5}{worst\_k}}(\textcolor{keywordtype}{int}* indices, \textcolor{keywordtype}{int} k)\{}
\DoxyCodeLine{252         \textcolor{keyword}{auto} comp\_values = [\textcolor{keyword}{this}](\textcolor{keywordtype}{int} x, \textcolor{keywordtype}{int} y)\{}
\DoxyCodeLine{253             \textcolor{keywordflow}{return} this-\/>values[x] > this-\/>values[y];}
\DoxyCodeLine{254         \};}
\DoxyCodeLine{255         std::vector<int> all\_ind(n\_particles());}
\DoxyCodeLine{256         std::iota(all\_ind.begin(), all\_ind.end(), 0);}
\DoxyCodeLine{257         std::sort(all\_ind.begin(), all\_ind.end(), comp\_values);}
\DoxyCodeLine{258         std::copy(all\_ind.data(), all\_ind.data()+k, indices);   }
\DoxyCodeLine{259     \}}
\DoxyCodeLine{266     \textcolor{keywordtype}{void} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_abfd37df0ae67d344d0f0640b196e0f03}{replace\_with}}(\mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer}{basic\_scontainer<T\_e, T\_dim>}}* cnt)\{}
\DoxyCodeLine{267         \textcolor{comment}{// sort the solutions in both containers}}
\DoxyCodeLine{268         std::vector<int> src\_ind(cnt-\/>n\_particles());}
\DoxyCodeLine{269         std::vector<int> des\_ind(n\_particles());}
\DoxyCodeLine{270         cnt-\/>\mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_aa1b9205c60b64912103c0d79cf164e70}{best\_k}}(src\_ind.data(), cnt-\/>n\_particles());}
\DoxyCodeLine{271         \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_aafc170ddfcde8fa6b8f0d763fb327ef5}{worst\_k}}(des\_ind.data(), n\_particles());}
\DoxyCodeLine{272         \textcolor{keywordtype}{int} src\_i=0, des\_i=0;}
\DoxyCodeLine{273         T\_e src\_b, des\_w;}
\DoxyCodeLine{274         \textcolor{keywordflow}{while}((src\_i < cnt-\/>n\_particles()) \&\& (des\_i < n\_particles()))\{}
\DoxyCodeLine{275             \textcolor{comment}{// repeat while the best solution in source is better than the worst in destination}}
\DoxyCodeLine{276             src\_b = cnt-\/>values[src\_ind[src\_i]];}
\DoxyCodeLine{277             des\_w = values[des\_ind[des\_i]];}
\DoxyCodeLine{278             \textcolor{keywordflow}{if}(des\_w <= src\_b)}
\DoxyCodeLine{279                 \textcolor{keywordflow}{break};}
\DoxyCodeLine{280 }
\DoxyCodeLine{281             std::copy(cnt-\/>particles[src\_ind[src\_i]].begin(),}
\DoxyCodeLine{282                       cnt-\/>particles[src\_ind[src\_i]].end(),}
\DoxyCodeLine{283                       particles[des\_ind[des\_i]].begin());}
\DoxyCodeLine{284             }
\DoxyCodeLine{285             values[des\_ind[des\_i]] = cnt-\/>values[src\_ind[src\_i]];}
\DoxyCodeLine{286             src\_i++;}
\DoxyCodeLine{287             des\_i++;}
\DoxyCodeLine{288         \}}
\DoxyCodeLine{289     \}}
\DoxyCodeLine{295     std::discrete\_distribution<int> \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a7fa9d1f300c7141e87d85ebaee81f6af}{weighted\_sampler}}()\{}
\DoxyCodeLine{296         std::vector<T\_e> weights;}
\DoxyCodeLine{297         T\_e max\_el = *std::max\_element(values.begin(), values.end());}
\DoxyCodeLine{298         \textcolor{keywordflow}{if}(max\_el == std::numeric\_limits<T\_e>::max())}
\DoxyCodeLine{299             weights.assign(values.size(), 1.0);}
\DoxyCodeLine{300         \textcolor{keywordflow}{else}\{}
\DoxyCodeLine{301             T\_e min\_el = *std::min\_element(values.begin(), values.end());}
\DoxyCodeLine{302             T\_e shift = 0.0001;}
\DoxyCodeLine{303             \textcolor{keywordflow}{if} (min\_el < 0.0)}
\DoxyCodeLine{304                 shift += -\/min\_el;}
\DoxyCodeLine{305             max\_el += shift;}
\DoxyCodeLine{306             weights.resize(n\_particles());}
\DoxyCodeLine{307             \textcolor{keywordflow}{for}(\textcolor{keywordtype}{int} p=0; p<n\_particles(); p++)}
\DoxyCodeLine{308                 weights[p] = max\_el -\/ (shift + values[p]);               }
\DoxyCodeLine{309         \}}
\DoxyCodeLine{310         \textcolor{comment}{// construct a distribution for weighted sampling}}
\DoxyCodeLine{311         std::discrete\_distribution<int> sampling\_dist(weights.begin(), weights.end());}
\DoxyCodeLine{312         \textcolor{keywordflow}{return} sampling\_dist;}
\DoxyCodeLine{313     \}}
\DoxyCodeLine{314 \};}
\DoxyCodeLine{315 }
\DoxyCodeLine{316 \}; \textcolor{comment}{// end of zagros namespace}}
\DoxyCodeLine{317 \}; \textcolor{comment}{// end of rocky namespace}}
\DoxyCodeLine{318 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
