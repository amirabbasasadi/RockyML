\hypertarget{communication_8h_source}{}\doxysection{communication.\+h}
\label{communication_8h_source}\index{include/rocky/zagros/strategies/communication.h@{include/rocky/zagros/strategies/communication.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{    Copyright (C) 2022 Amirabbas Asadi , All Rights Reserved}}
\DoxyCodeLine{3 \textcolor{comment}{    distributed under Apache-\/2.0 license}}
\DoxyCodeLine{4 \textcolor{comment}{*/}}
\DoxyCodeLine{5 \textcolor{preprocessor}{\#ifndef ROCKY\_ZAGROS\_COMM\_STRATEGY}}
\DoxyCodeLine{6 \textcolor{preprocessor}{\#define ROCKY\_ZAGROS\_COMM\_STRATEGY}}
\DoxyCodeLine{7 }
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include <rocky/zagros/strategies/strategy.h>}}
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include<nlohmann/json.hpp>}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include<cpr/cpr.h>}}
\DoxyCodeLine{11 }
\DoxyCodeLine{12 }
\DoxyCodeLine{13 }
\DoxyCodeLine{14 \textcolor{keyword}{namespace }rocky\{}
\DoxyCodeLine{15 \textcolor{keyword}{namespace }zagros\{}
\DoxyCodeLine{20 \textcolor{keyword}{template}<\textcolor{keyword}{typename} T\_e, \textcolor{keywordtype}{int} T\_dim>}
\DoxyCodeLine{21 \textcolor{keyword}{class }\mbox{\hyperlink{classrocky_1_1zagros_1_1comm__strategy}{comm\_strategy}}: \textcolor{keyword}{public} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__strategy}{basic\_strategy}}<T\_e, T\_dim>\{}
\DoxyCodeLine{22 \textcolor{keyword}{public}:}
\DoxyCodeLine{23     \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} apply() = 0;}
\DoxyCodeLine{24 \};}
\DoxyCodeLine{25 }
\DoxyCodeLine{26 }
\DoxyCodeLine{27 \textcolor{preprocessor}{\#ifdef ROCKY\_USE\_MPI}}
\DoxyCodeLine{32 \textcolor{keyword}{template}<\textcolor{keyword}{typename} T\_e, \textcolor{keywordtype}{int} T\_dim>}
\DoxyCodeLine{33 \textcolor{keyword}{class }mpi\_strategy: \textcolor{keyword}{public} \mbox{\hyperlink{classrocky_1_1zagros_1_1comm__strategy}{comm\_strategy}}<T\_e, T\_dim>\{}
\DoxyCodeLine{34 \textcolor{keyword}{protected}:}
\DoxyCodeLine{35      \textcolor{comment}{// number of MPI processes}}
\DoxyCodeLine{36     \textcolor{keywordtype}{int} mpi\_num\_procs\_;}
\DoxyCodeLine{37     \textcolor{comment}{// MPI rank}}
\DoxyCodeLine{38     \textcolor{keywordtype}{int} mpi\_rank\_; }
\DoxyCodeLine{39 \textcolor{keyword}{public}:}
\DoxyCodeLine{47     \textcolor{keywordtype}{void} fetch\_mpi\_info()\{}
\DoxyCodeLine{48         MPI\_Comm\_size(MPI\_COMM\_WORLD, \&mpi\_num\_procs\_);}
\DoxyCodeLine{49         MPI\_Comm\_rank(MPI\_COMM\_WORLD, \&mpi\_rank\_);}
\DoxyCodeLine{50     \}}
\DoxyCodeLine{51 }
\DoxyCodeLine{52     \textcolor{keywordtype}{int} mpi\_num\_procs()\textcolor{keyword}{ const}\{}
\DoxyCodeLine{53         \textcolor{keywordflow}{return} mpi\_num\_procs\_;}
\DoxyCodeLine{54     \}}
\DoxyCodeLine{55     \textcolor{keywordtype}{int} mpi\_rank()\textcolor{keyword}{ const}\{}
\DoxyCodeLine{56         \textcolor{keywordflow}{return} mpi\_rank\_;}
\DoxyCodeLine{57     \}}
\DoxyCodeLine{58 }
\DoxyCodeLine{59 \};}
\DoxyCodeLine{60 }
\DoxyCodeLine{65 \textcolor{keyword}{template}<\textcolor{keyword}{typename} T\_e, \textcolor{keywordtype}{int} T\_dim>}
\DoxyCodeLine{66 \textcolor{keyword}{class }sync\_broadcast\_best: \textcolor{keyword}{public} mpi\_strategy<T\_e, T\_dim>\{}
\DoxyCodeLine{67 \textcolor{keyword}{protected}:}
\DoxyCodeLine{68     basic\_scontainer<T\_e, T\_dim>* cluster\_best\_container\_;}
\DoxyCodeLine{69 \textcolor{keyword}{public}:}
\DoxyCodeLine{70     \textcolor{keywordtype}{void} set\_target\_container(basic\_scontainer<T\_e, T\_dim>* container)\{}
\DoxyCodeLine{71         this-\/>set\_target\_container = container;}
\DoxyCodeLine{72     \}}
\DoxyCodeLine{73     sync\_broadcast\_best(basic\_scontainer<T\_e, T\_dim>* container)\{}
\DoxyCodeLine{74         this-\/>cluster\_best\_container\_ = container;}
\DoxyCodeLine{75         this-\/>fetch\_mpi\_info();}
\DoxyCodeLine{76     \}}
\DoxyCodeLine{77     sync\_broadcast\_best()\{}
\DoxyCodeLine{78         this-\/>cluster\_best\_container\_ = \textcolor{keyword}{nullptr};}
\DoxyCodeLine{79         this-\/>fetch\_mpi\_info();}
\DoxyCodeLine{80     \}}
\DoxyCodeLine{81     \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} apply()\{}
\DoxyCodeLine{82         \textcolor{comment}{// identify the process}}
\DoxyCodeLine{83         \textcolor{keywordtype}{int} rank = this-\/>mpi\_rank();}
\DoxyCodeLine{84         \textcolor{comment}{// ask everyone in the cluster to find the min value}}
\DoxyCodeLine{85         \textcolor{keyword}{struct }\{}
\DoxyCodeLine{86             T\_e cluster\_best\_min;}
\DoxyCodeLine{87             \textcolor{keywordtype}{int} rank;}
\DoxyCodeLine{88         \} data\_out, result;}
\DoxyCodeLine{89 }
\DoxyCodeLine{90         data\_out.cluster\_best\_min = cluster\_best\_container\_-\/>values[0];}
\DoxyCodeLine{91         data\_out.rank = rank;}
\DoxyCodeLine{92 }
\DoxyCodeLine{93         \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr}(std::is\_same<T\_e, double>::value)\{}
\DoxyCodeLine{94             MPI\_Allreduce(\&data\_out, \&result, 1, MPI\_DOUBLE\_INT, MPI\_MINLOC, MPI\_COMM\_WORLD);}
\DoxyCodeLine{95             MPI\_Bcast(cluster\_best\_container\_-\/>particle(0), T\_dim, MPI\_DOUBLE, result.rank, MPI\_COMM\_WORLD);}
\DoxyCodeLine{96         \}}
\DoxyCodeLine{97         \textcolor{keywordflow}{if} \textcolor{keyword}{constexpr}(std::is\_same<T\_e, float>::value)\{}
\DoxyCodeLine{98             MPI\_Allreduce(\&data\_out, \&result, 1, MPI\_FLOAT\_INT, MPI\_MINLOC, MPI\_COMM\_WORLD);}
\DoxyCodeLine{99             MPI\_Bcast(cluster\_best\_container\_-\/>particle(0), T\_dim, MPI\_FLOAT, result.rank, MPI\_COMM\_WORLD);}
\DoxyCodeLine{100         \} }
\DoxyCodeLine{101         cluster\_best\_container\_-\/>values[0] = result.cluster\_best\_min;}
\DoxyCodeLine{102     \}}
\DoxyCodeLine{103 \};}
\DoxyCodeLine{108 \textcolor{keyword}{template}<\textcolor{keyword}{typename} T\_e, \textcolor{keywordtype}{int} T\_dim>}
\DoxyCodeLine{109 \textcolor{keyword}{class }sync\_bcd\_mask: \textcolor{keyword}{public} mpi\_strategy<T\_e, T\_dim>\{}
\DoxyCodeLine{110 \textcolor{keyword}{protected}:}
\DoxyCodeLine{111     \textcolor{keywordtype}{int}* bcd\_mask\_;}
\DoxyCodeLine{112 \textcolor{keyword}{public}:}
\DoxyCodeLine{113     sync\_bcd\_mask(\textcolor{keywordtype}{int}* bcd\_mask)\{}
\DoxyCodeLine{114         this-\/>bcd\_mask\_ = bcd\_mask;}
\DoxyCodeLine{115         this-\/>fetch\_mpi\_info();}
\DoxyCodeLine{116     \}}
\DoxyCodeLine{117     \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} apply()\{}
\DoxyCodeLine{118         MPI\_Bcast(this-\/>bcd\_mask\_, T\_dim, MPI\_INT, 0, MPI\_COMM\_WORLD);}
\DoxyCodeLine{119     \}}
\DoxyCodeLine{120 \};}
\DoxyCodeLine{121 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{122 }
\DoxyCodeLine{123 \};}
\DoxyCodeLine{124 \};}
\DoxyCodeLine{125 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
