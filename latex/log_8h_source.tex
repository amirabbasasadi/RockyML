\hypertarget{log_8h_source}{}\doxysection{log.\+h}
\label{log_8h_source}\index{include/rocky/zagros/strategies/log.h@{include/rocky/zagros/strategies/log.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{    Copyright (C) 2022 Amirabbas Asadi , All Rights Reserved}}
\DoxyCodeLine{3 \textcolor{comment}{    distributed under Apache-\/2.0 license}}
\DoxyCodeLine{4 \textcolor{comment}{*/}}
\DoxyCodeLine{5 \textcolor{preprocessor}{\#ifndef ROCKY\_ZAGROS\_LOG\_STRATEGY}}
\DoxyCodeLine{6 \textcolor{preprocessor}{\#define ROCKY\_ZAGROS\_LOG\_STRATEGY}}
\DoxyCodeLine{7 }
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include<rocky/zagros/strategies/strategy.h>}}
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include<rocky/zagros/strategies/communication.h>}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include<nlohmann/json.hpp>}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include<cpr/cpr.h>}}
\DoxyCodeLine{12 }
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include<future>}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include<fstream>}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include<sstream>}}
\DoxyCodeLine{16 }
\DoxyCodeLine{17 \textcolor{keyword}{namespace }rocky\{}
\DoxyCodeLine{18 \textcolor{keyword}{namespace }zagros\{}
\DoxyCodeLine{19 }
\DoxyCodeLine{24 \textcolor{keyword}{template}<\textcolor{keyword}{typename} T\_e, \textcolor{keywordtype}{int} T\_dim>}
\DoxyCodeLine{25 \textcolor{keyword}{class }\mbox{\hyperlink{classrocky_1_1zagros_1_1logging__strategy}{logging\_strategy}}: \textcolor{keyword}{public} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__strategy}{basic\_strategy}}<T\_e, T\_dim>\{\};}
\DoxyCodeLine{26 }
\DoxyCodeLine{27 \textcolor{keyword}{struct }\mbox{\hyperlink{structrocky_1_1zagros_1_1local__optimization__log}{local\_optimization\_log}}\{}
\DoxyCodeLine{28     std::string filename;}
\DoxyCodeLine{29     \textcolor{keywordtype}{bool} log\_groups;}
\DoxyCodeLine{30     std::fstream* log\_output;}
\DoxyCodeLine{31     \textcolor{keywordtype}{size\_t} step;}
\DoxyCodeLine{32     \mbox{\hyperlink{structrocky_1_1zagros_1_1local__optimization__log}{local\_optimization\_log}}(std::fstream\& log\_output, std::string filename,  \textcolor{keywordtype}{bool} log\_groups=\textcolor{keyword}{false})\{}
\DoxyCodeLine{33         this-\/>filename = filename;}
\DoxyCodeLine{34         this-\/>log\_output = \&log\_output;}
\DoxyCodeLine{35         this-\/>step = 0;}
\DoxyCodeLine{36         this-\/>log\_groups = log\_groups;}
\DoxyCodeLine{37         \textcolor{comment}{// openning the log file}}
\DoxyCodeLine{38         this-\/>open();}
\DoxyCodeLine{39         \textcolor{comment}{// write the headers}}
\DoxyCodeLine{40         this-\/>write\_header();}
\DoxyCodeLine{41     \}}
\DoxyCodeLine{42     \textcolor{keywordtype}{void} open()\{}
\DoxyCodeLine{43         \textcolor{comment}{// create a specific filename for this rank}}
\DoxyCodeLine{44         \textcolor{keywordtype}{int} mpi\_rank;}
\DoxyCodeLine{45         MPI\_Comm\_rank(MPI\_COMM\_WORLD, \&mpi\_rank);}
\DoxyCodeLine{46         std::string process\_spc\_filename = fmt::format(\textcolor{stringliteral}{"{}proc\_\{\}\_\{\}"{}}, mpi\_rank, filename);}
\DoxyCodeLine{47         \textcolor{comment}{// initialize the output file}}
\DoxyCodeLine{48         log\_output-\/>open(process\_spc\_filename, std::fstream::out);}
\DoxyCodeLine{49     \}}
\DoxyCodeLine{50     std::fstream\& stream()\{}
\DoxyCodeLine{51         \textcolor{keywordflow}{return} *log\_output;}
\DoxyCodeLine{52     \}}
\DoxyCodeLine{53     \textcolor{keywordtype}{void} write\_header()\{}
\DoxyCodeLine{54         \textcolor{keywordflow}{if} (this-\/>log\_groups)}
\DoxyCodeLine{55             this-\/>stream() << \textcolor{stringliteral}{"{}step,group,best"{}} << std::endl;}
\DoxyCodeLine{56         \textcolor{keywordflow}{else}}
\DoxyCodeLine{57             this-\/>stream() << \textcolor{stringliteral}{"{}step,best"{}} << std::endl;}
\DoxyCodeLine{58     \}}
\DoxyCodeLine{59     \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} save()\{}
\DoxyCodeLine{60         this-\/>stream() << \textcolor{stringliteral}{"{}-\/-\/-\/"{}} << std::endl;}
\DoxyCodeLine{61         \textcolor{keywordflow}{if}(this-\/>log\_output-\/>is\_open())}
\DoxyCodeLine{62             this-\/>log\_output-\/>close();}
\DoxyCodeLine{63     \}}
\DoxyCodeLine{64     \textcolor{keyword}{virtual} \mbox{\hyperlink{structrocky_1_1zagros_1_1local__optimization__log}{\string~local\_optimization\_log}}()\{}
\DoxyCodeLine{65         this-\/>save();}
\DoxyCodeLine{66     \}}
\DoxyCodeLine{67 \};}
\DoxyCodeLine{68 }
\DoxyCodeLine{73 \textcolor{keyword}{template}<\textcolor{keyword}{typename} T\_e, \textcolor{keywordtype}{int} T\_dim>}
\DoxyCodeLine{74 \textcolor{keyword}{class }\mbox{\hyperlink{classrocky_1_1zagros_1_1local__log__best}{local\_log\_best}}: \textcolor{keyword}{public} \mbox{\hyperlink{classrocky_1_1zagros_1_1logging__strategy}{logging\_strategy}}<T\_e, T\_dim>\{}
\DoxyCodeLine{75 \textcolor{keyword}{protected}:}
\DoxyCodeLine{76     \mbox{\hyperlink{classrocky_1_1zagros_1_1system}{system<T\_e>}}* problem\_;}
\DoxyCodeLine{77     \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer}{basic\_scontainer<T\_e, T\_dim>}}* container\_;}
\DoxyCodeLine{78     \mbox{\hyperlink{structrocky_1_1zagros_1_1local__optimization__log}{local\_optimization\_log}}* handler\_;}
\DoxyCodeLine{79 }
\DoxyCodeLine{80 \textcolor{keyword}{public}:}
\DoxyCodeLine{81     \mbox{\hyperlink{classrocky_1_1zagros_1_1local__log__best}{local\_log\_best}}(\mbox{\hyperlink{classrocky_1_1zagros_1_1system}{system<T\_e>}}* problem, \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer}{basic\_scontainer<T\_e, T\_dim>}}* container, \mbox{\hyperlink{structrocky_1_1zagros_1_1local__optimization__log}{local\_optimization\_log}}* handler)\{}
\DoxyCodeLine{82         this-\/>problem\_ = problem;}
\DoxyCodeLine{83         this-\/>container\_ = container;}
\DoxyCodeLine{84         this-\/>handler\_ = handler;}
\DoxyCodeLine{85         }
\DoxyCodeLine{86     \}}
\DoxyCodeLine{87     \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} write\_header()\{}
\DoxyCodeLine{88         \textcolor{keywordflow}{if} (this-\/>handler\_-\/>log\_groups)}
\DoxyCodeLine{89             this-\/>handler\_-\/>stream() << \textcolor{stringliteral}{"{}step,group,best"{}} << std::endl;}
\DoxyCodeLine{90         \textcolor{keywordflow}{else}}
\DoxyCodeLine{91             this-\/>handler\_-\/>stream() << \textcolor{stringliteral}{"{}step,best"{}} << std::endl;}
\DoxyCodeLine{92     \}}
\DoxyCodeLine{93     \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} apply()\{}
\DoxyCodeLine{94         \textcolor{comment}{// find the best solution}}
\DoxyCodeLine{95         T\_e best = container\_-\/>\mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_ac2a40d121ffe0ac18cfe3d24aecdcdcd}{best\_min}}();}
\DoxyCodeLine{96         this-\/>handler\_-\/>stream() << fmt::format(\textcolor{stringliteral}{"{}\{\},\{\}"{}}, this-\/>handler\_-\/>step, best) << std::endl;}
\DoxyCodeLine{97         this-\/>handler\_-\/>step++;}
\DoxyCodeLine{98     \};}
\DoxyCodeLine{99 \};}
\DoxyCodeLine{100 }
\DoxyCodeLine{101 \textcolor{keyword}{struct }\mbox{\hyperlink{structrocky_1_1zagros_1_1comet__optimization__log}{comet\_optimization\_log}}\{}
\DoxyCodeLine{102     std::string comet\_api\_key\_;}
\DoxyCodeLine{103     std::string workspace\_;}
\DoxyCodeLine{104     std::string project\_;}
\DoxyCodeLine{105     std::string metric\_name\_;}
\DoxyCodeLine{106     std::string experiment\_name\_;}
\DoxyCodeLine{107     std::string experiment\_link\_;}
\DoxyCodeLine{108     std::string experiment\_key\_;}
\DoxyCodeLine{109 }
\DoxyCodeLine{110     \mbox{\hyperlink{structrocky_1_1zagros_1_1comet__optimization__log}{comet\_optimization\_log}}(std::string comet\_api\_key, std::string workspace, std::string project, std::string metric\_name)\{}
\DoxyCodeLine{111         this-\/>comet\_api\_key\_ = comet\_api\_key;}
\DoxyCodeLine{112         this-\/>workspace\_ = workspace;}
\DoxyCodeLine{113         this-\/>project\_ = project;}
\DoxyCodeLine{114         this-\/>metric\_name\_ = metric\_name;}
\DoxyCodeLine{115         \textcolor{comment}{// we need to make sure in an MPI app only the root process will create the experiment        }}
\DoxyCodeLine{116         this-\/>create\_experiment();   }
\DoxyCodeLine{117     \}}
\DoxyCodeLine{118     \textcolor{keywordtype}{void} create\_experiment()\{}
\DoxyCodeLine{119         spdlog::info(\textcolor{stringliteral}{"{}creating comet experiment..."{}});}
\DoxyCodeLine{120         \textcolor{comment}{// encoding experiment data}}
\DoxyCodeLine{121         nlohmann::json experiment\_data = \{\{\textcolor{stringliteral}{"{}workspaceName"{}}, this-\/>workspace\_\},}
\DoxyCodeLine{122                                           \{\textcolor{stringliteral}{"{}projectName"{}}, this-\/>project\_\}\};}
\DoxyCodeLine{123         \textcolor{comment}{// sending a post request for creating the experiment}}
\DoxyCodeLine{124         cpr::Response r = cpr::Post(cpr::Url\{\textcolor{stringliteral}{"{}https://www.comet.com/api/rest/v2/write/experiment/create"{}}\},}
\DoxyCodeLine{125                                     cpr::Header\{\{\textcolor{stringliteral}{"{}Authorization"{}}, this-\/>comet\_api\_key\_\},}
\DoxyCodeLine{126                                                 \{\textcolor{stringliteral}{"{}Content-\/type"{}}, \textcolor{stringliteral}{"{}application/json"{}}\},}
\DoxyCodeLine{127                                                 \{\textcolor{stringliteral}{"{}Accept"{}}, \textcolor{stringliteral}{"{}application/json"{}}\}\},}
\DoxyCodeLine{128                                     cpr::Body\{experiment\_data.dump()\});}
\DoxyCodeLine{129         \textcolor{comment}{// warn the user if connection wasn't successful}}
\DoxyCodeLine{130         this-\/>connection\_warning(r.status\_code);}
\DoxyCodeLine{131         nlohmann::json rdata = nlohmann::json::parse(r.text);}
\DoxyCodeLine{132         \textcolor{comment}{// store the exepriment information}}
\DoxyCodeLine{133         this-\/>experiment\_name\_ = rdata[\textcolor{stringliteral}{"{}name"{}}];}
\DoxyCodeLine{134         this-\/>experiment\_link\_ = rdata[\textcolor{stringliteral}{"{}link"{}}];}
\DoxyCodeLine{135         \textcolor{comment}{// experiment key will be needed for submitting metric values}}
\DoxyCodeLine{136         this-\/>experiment\_key\_ = rdata[\textcolor{stringliteral}{"{}experimentKey"{}}];}
\DoxyCodeLine{137         std::string proc\_metric\_name = get\_metric\_name();}
\DoxyCodeLine{138         spdlog::info(\textcolor{stringliteral}{"{}\{\} experiment name : \{\}"{}}, proc\_metric\_name, this-\/>experiment\_name\_);}
\DoxyCodeLine{139         spdlog::info(\textcolor{stringliteral}{"{}\{\} experiment link : \{\}"{}}, proc\_metric\_name, this-\/>experiment\_link\_);}
\DoxyCodeLine{140         spdlog::info(\textcolor{stringliteral}{"{}\{\} experiment key : \{\}"{}}, proc\_metric\_name, this-\/>experiment\_key\_);}
\DoxyCodeLine{141     \}}
\DoxyCodeLine{142     \textcolor{keywordtype}{void} broadcast\_experiment()\{}
\DoxyCodeLine{143         \textcolor{comment}{// root process should broadcast the experiment info}}
\DoxyCodeLine{144         \textcolor{keywordtype}{int} mpi\_rank;}
\DoxyCodeLine{145         MPI\_Comm\_rank(MPI\_COMM\_WORLD, \&mpi\_rank);}
\DoxyCodeLine{146         \textcolor{comment}{// a buffer for experiment key}}
\DoxyCodeLine{147         \textcolor{keywordtype}{char} key\_buffer[33];}
\DoxyCodeLine{148         \textcolor{keywordflow}{if}(mpi\_rank == 0)}
\DoxyCodeLine{149             sprintf(key\_buffer, \textcolor{stringliteral}{"{}\%.32s"{}}, experiment\_key\_.c\_str());}
\DoxyCodeLine{150         spdlog::info(\textcolor{stringliteral}{"{}broadcasting experiment information to all processes..."{}});}
\DoxyCodeLine{151         MPI\_Bcast(key\_buffer, 32, MPI\_CHAR, 0, MPI\_COMM\_WORLD);}
\DoxyCodeLine{152         \textcolor{keywordflow}{if}(mpi\_rank != 0)\{}
\DoxyCodeLine{153             experiment\_key\_ = std::string(key\_buffer);}
\DoxyCodeLine{154             spdlog::info(\textcolor{stringliteral}{"{}process \{\} has the key : \{\}"{}}, mpi\_rank, experiment\_key\_);}
\DoxyCodeLine{155         \}}
\DoxyCodeLine{156     \}}
\DoxyCodeLine{157     std::string get\_metric\_name()\{}
\DoxyCodeLine{158         \textcolor{keywordtype}{int} mpi\_rank;}
\DoxyCodeLine{159         MPI\_Comm\_rank(MPI\_COMM\_WORLD, \&mpi\_rank);}
\DoxyCodeLine{160         std::string name = fmt::format(\textcolor{stringliteral}{"{}proc\_\{\}\_\{\}"{}}, mpi\_rank, metric\_name\_);}
\DoxyCodeLine{161         \textcolor{keywordflow}{return} name;}
\DoxyCodeLine{162     \}}
\DoxyCodeLine{163     \textcolor{keywordtype}{void} connection\_warning(\textcolor{keywordtype}{int} status\_code)\{}
\DoxyCodeLine{164         \textcolor{keywordflow}{if}(status\_code != 200)}
\DoxyCodeLine{165             spdlog::warn(\textcolor{stringliteral}{"{}Error while connecting Comet server! request status code : \{\}"{}}, status\_code);}
\DoxyCodeLine{166     \}}
\DoxyCodeLine{167 \};}
\DoxyCodeLine{168 }
\DoxyCodeLine{173 \textcolor{keyword}{template}<\textcolor{keyword}{typename} T\_e, \textcolor{keywordtype}{int} T\_dim>}
\DoxyCodeLine{174 \textcolor{keyword}{class }\mbox{\hyperlink{classrocky_1_1zagros_1_1comet__strategy}{comet\_strategy}}: \textcolor{keyword}{public} \mbox{\hyperlink{classrocky_1_1zagros_1_1logging__strategy}{logging\_strategy}}<T\_e, T\_dim>\{\};}
\DoxyCodeLine{175 }
\DoxyCodeLine{180 \textcolor{keyword}{template}<\textcolor{keyword}{typename} T\_e, \textcolor{keywordtype}{int} T\_dim>}
\DoxyCodeLine{181 \textcolor{keyword}{class }\mbox{\hyperlink{classrocky_1_1zagros_1_1comet__log__best}{comet\_log\_best}}: \textcolor{keyword}{public} \mbox{\hyperlink{classrocky_1_1zagros_1_1comet__strategy}{comet\_strategy}}<T\_e, T\_dim>\{}
\DoxyCodeLine{182 \textcolor{keyword}{protected}:}
\DoxyCodeLine{183     \mbox{\hyperlink{classrocky_1_1zagros_1_1system}{system<T\_e>}}* problem\_;}
\DoxyCodeLine{184     \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer}{basic\_scontainer<T\_e, T\_dim>}}* container\_;}
\DoxyCodeLine{185     \mbox{\hyperlink{structrocky_1_1zagros_1_1comet__optimization__log}{comet\_optimization\_log}}* handler\_;}
\DoxyCodeLine{186 }
\DoxyCodeLine{187 \textcolor{keyword}{public}:}
\DoxyCodeLine{188     \mbox{\hyperlink{classrocky_1_1zagros_1_1comet__log__best}{comet\_log\_best}}(\mbox{\hyperlink{classrocky_1_1zagros_1_1system}{system<T\_e>}}* problem, \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer}{basic\_scontainer<T\_e, T\_dim>}}* container, \mbox{\hyperlink{structrocky_1_1zagros_1_1comet__optimization__log}{comet\_optimization\_log}}* handler)\{}
\DoxyCodeLine{189         this-\/>problem\_ = problem;}
\DoxyCodeLine{190         this-\/>container\_ = container;}
\DoxyCodeLine{191         this-\/>handler\_ = handler;}
\DoxyCodeLine{192     \}}
\DoxyCodeLine{193     \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} apply()\{}
\DoxyCodeLine{194          \textcolor{comment}{// find the best solution}}
\DoxyCodeLine{195         T\_e best = container\_-\/>\mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_ac2a40d121ffe0ac18cfe3d24aecdcdcd}{best\_min}}();}
\DoxyCodeLine{196         \textcolor{comment}{// encode the metric data}}
\DoxyCodeLine{197         nlohmann::json metric\_data = \{\{\textcolor{stringliteral}{"{}experimentKey"{}}, handler\_-\/>experiment\_key\_\},}
\DoxyCodeLine{198                                       \{\textcolor{stringliteral}{"{}metricName"{}}, handler\_-\/>get\_metric\_name()\},}
\DoxyCodeLine{199                                       \{\textcolor{stringliteral}{"{}metricValue"{}}, best\}\};}
\DoxyCodeLine{200         \textcolor{comment}{// send metric data using an async call}}
\DoxyCodeLine{201         \textcolor{keyword}{auto} req\_future = std::async([\textcolor{keyword}{this}, \&metric\_data]()\{}
\DoxyCodeLine{202             cpr::Response r = cpr::Post(cpr::Url\{\textcolor{stringliteral}{"{}https://www.comet.com/api/rest/v2/write/experiment/metric"{}}\},}
\DoxyCodeLine{203                                 cpr::Header\{\{\textcolor{stringliteral}{"{}Authorization"{}}, this-\/>handler\_-\/>comet\_api\_key\_\},}
\DoxyCodeLine{204                                             \{\textcolor{stringliteral}{"{}Content-\/type"{}}, \textcolor{stringliteral}{"{}application/json"{}}\},}
\DoxyCodeLine{205                                             \{\textcolor{stringliteral}{"{}Accept"{}}, \textcolor{stringliteral}{"{}application/json"{}}\}\},}
\DoxyCodeLine{206                                 cpr::Body\{metric\_data.dump()\});}
\DoxyCodeLine{207             this-\/>handler\_-\/>connection\_warning(r.status\_code);}
\DoxyCodeLine{208         \});}
\DoxyCodeLine{209         }
\DoxyCodeLine{210     \};}
\DoxyCodeLine{211 \};}
\DoxyCodeLine{212 }
\DoxyCodeLine{213 \};}
\DoxyCodeLine{214 \};}
\DoxyCodeLine{215 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
