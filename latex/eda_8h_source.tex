\hypertarget{eda_8h_source}{}\doxysection{eda.\+h}
\label{eda_8h_source}\index{include/rocky/zagros/strategies/eda.h@{include/rocky/zagros/strategies/eda.h}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{    Copyright (C) 2022 Amirabbas Asadi , All Rights Reserved}}
\DoxyCodeLine{3 \textcolor{comment}{    distributed under Apache-\/2.0 license}}
\DoxyCodeLine{4 \textcolor{comment}{*/}}
\DoxyCodeLine{5 \textcolor{preprocessor}{\#ifndef ROCKY\_ZAGROS\_EDA\_STRATEGY}}
\DoxyCodeLine{6 \textcolor{preprocessor}{\#define ROCKY\_ZAGROS\_EDA\_STRATEGY}}
\DoxyCodeLine{7 }
\DoxyCodeLine{8 }
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include <rocky/zagros/strategies/strategy.h>}}
\DoxyCodeLine{10 }
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include <Eigen/Core>}}
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include <Eigen/Cholesky>}}
\DoxyCodeLine{13 }
\DoxyCodeLine{14 }
\DoxyCodeLine{15 \textcolor{keyword}{namespace }rocky\{}
\DoxyCodeLine{16 \textcolor{keyword}{namespace }zagros\{}
\DoxyCodeLine{17 }
\DoxyCodeLine{22 \textcolor{keyword}{template}<\textcolor{keyword}{typename} T\_e, \textcolor{keywordtype}{int} T\_dim>}
\DoxyCodeLine{23 \textcolor{keyword}{class }\mbox{\hyperlink{classrocky_1_1zagros_1_1eda__strategy}{eda\_strategy}}: \textcolor{keyword}{public} \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__strategy}{basic\_strategy}}<T\_e, T\_dim>\{\};}
\DoxyCodeLine{24 }
\DoxyCodeLine{29 \textcolor{keyword}{template}<\textcolor{keyword}{typename} T\_e, \textcolor{keywordtype}{int} T\_dim>}
\DoxyCodeLine{30 \textcolor{keyword}{class }\mbox{\hyperlink{classrocky_1_1zagros_1_1eda__mutivariate__normal}{eda\_mutivariate\_normal}}: \textcolor{keyword}{public} \mbox{\hyperlink{classrocky_1_1zagros_1_1eda__strategy}{eda\_strategy}}<T\_e, T\_dim>\{}
\DoxyCodeLine{31 \textcolor{keyword}{protected}:}
\DoxyCodeLine{32     \textcolor{comment}{// system}}
\DoxyCodeLine{33     \mbox{\hyperlink{classrocky_1_1zagros_1_1system}{system<T\_e>}}* problem\_;}
\DoxyCodeLine{34     \textcolor{comment}{// main container}}
\DoxyCodeLine{35     \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer}{basic\_scontainer<T\_e, T\_dim>}}* target\_container\_;}
\DoxyCodeLine{36     \textcolor{comment}{// container holding the generated candidates}}
\DoxyCodeLine{37     \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer}{basic\_scontainer<T\_e, T\_dim>}}* candidates\_container\_;}
\DoxyCodeLine{38     \textcolor{comment}{// number of generated candidates}}
\DoxyCodeLine{39     std::vector<T\_e> top\_particles\_mem\_; }
\DoxyCodeLine{40     \textcolor{comment}{// a placeholder for top-\/k solutions}}
\DoxyCodeLine{41     std::vector<int> solution\_ind\_;}
\DoxyCodeLine{42     \textcolor{comment}{// covariance matrix}}
\DoxyCodeLine{43     std::vector<T\_e> cov\_mem\_;}
\DoxyCodeLine{44     \textcolor{comment}{// mean vector}}
\DoxyCodeLine{45     std::vector<T\_e> mean\_mem\_;}
\DoxyCodeLine{46     \textcolor{comment}{// sample size for computing covariance matrix}}
\DoxyCodeLine{47     \textcolor{keywordtype}{int} sample\_size\_;}
\DoxyCodeLine{48     \textcolor{comment}{// number of generated candidates in each step}}
\DoxyCodeLine{49     \textcolor{keywordtype}{int} n\_candidates\_;}
\DoxyCodeLine{50 }
\DoxyCodeLine{51 \textcolor{keyword}{public}:}
\DoxyCodeLine{52     \mbox{\hyperlink{classrocky_1_1zagros_1_1eda__mutivariate__normal}{eda\_mutivariate\_normal}}(\mbox{\hyperlink{classrocky_1_1zagros_1_1system}{system<T\_e>}}* problem, \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer}{basic\_scontainer<T\_e, T\_dim>}}* tgt\_container, \mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer}{basic\_scontainer<T\_e, T\_dim>}}* cnd\_container, \textcolor{keywordtype}{int} sample\_size)\{}
\DoxyCodeLine{53         this-\/>problem\_ = problem;}
\DoxyCodeLine{54         this-\/>target\_container\_ = tgt\_container;}
\DoxyCodeLine{55         this-\/>candidates\_container\_ = cnd\_container;}
\DoxyCodeLine{56         this-\/>sample\_size\_ = sample\_size;}
\DoxyCodeLine{57         this-\/>n\_candidates\_ = cnd\_container-\/>n\_particles();}
\DoxyCodeLine{58         top\_particles\_mem\_.resize(sample\_size * T\_dim);}
\DoxyCodeLine{59         solution\_ind\_.resize(sample\_size);}
\DoxyCodeLine{60         cov\_mem\_.resize(T\_dim * T\_dim);}
\DoxyCodeLine{61         mean\_mem\_.resize(T\_dim);}
\DoxyCodeLine{62     \}}
\DoxyCodeLine{63     \textcolor{keywordtype}{void} sample\_std\_normal(T\_e* vec)\{}
\DoxyCodeLine{64         \textcolor{keyword}{static} std::normal\_distribution<T\_e> dist(0.0, 1.0);}
\DoxyCodeLine{65         tbb::parallel\_for(0, T\_dim, [\&](\textcolor{keyword}{auto} i)\{}
\DoxyCodeLine{66             vec[i] = dist(rocky::utils::random::prng());}
\DoxyCodeLine{67         \});}
\DoxyCodeLine{68     \}}
\DoxyCodeLine{69     \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} apply()\{}
\DoxyCodeLine{70         \textcolor{comment}{// find top k solutions}}
\DoxyCodeLine{71         target\_container\_-\/>\mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_aa1b9205c60b64912103c0d79cf164e70}{best\_k}}(solution\_ind\_.data(), sample\_size\_);}
\DoxyCodeLine{72         \textcolor{comment}{// copy the best soluions}}
\DoxyCodeLine{73         T\_e* top\_particles\_ptr = top\_particles\_mem\_.data();}
\DoxyCodeLine{74 }
\DoxyCodeLine{75         tbb::parallel\_for(0, sample\_size\_, [\&](\textcolor{keywordtype}{int} p)\{}
\DoxyCodeLine{76             std::copy(this-\/>target\_container\_-\/>\mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_ab608784fc75d08bba940962dfd5761b5}{particle}}(this-\/>solution\_ind\_[p]),}
\DoxyCodeLine{77                       this-\/>target\_container\_-\/>particle(this-\/>solution\_ind\_[p]) + T\_dim,}
\DoxyCodeLine{78                       top\_particles\_ptr + p * T\_dim);}
\DoxyCodeLine{79         \});}
\DoxyCodeLine{80         \textcolor{comment}{// estimate the mean and covariance}}
\DoxyCodeLine{81         Eigen::Map<Eigen::Matrix<T\_e, Eigen::Dynamic, Eigen::Dynamic, Eigen::RowMajor>> top\_particles\_mat(top\_particles\_mem\_.data(), sample\_size\_, T\_dim);}
\DoxyCodeLine{82         Eigen::Map<Eigen::Matrix<T\_e, Eigen::Dynamic, Eigen::Dynamic, Eigen::RowMajor>> cov\_mat(cov\_mem\_.data(), T\_dim, T\_dim);}
\DoxyCodeLine{83         Eigen::Map<Eigen::Matrix<T\_e, 1, T\_dim, Eigen::RowMajor>> mean\_mat(mean\_mem\_.data());}
\DoxyCodeLine{84 }
\DoxyCodeLine{85         mean\_mat = top\_particles\_mat.colwise().mean();}
\DoxyCodeLine{86         top\_particles\_mat.rowwise() -\/= mean\_mat;}
\DoxyCodeLine{87         cov\_mat = (top\_particles\_mat.adjoint() * top\_particles\_mat) / \textcolor{keyword}{static\_cast<}T\_e\textcolor{keyword}{>}(sample\_size\_-\/1);}
\DoxyCodeLine{88         \textcolor{comment}{// cholesky decomposition}}
\DoxyCodeLine{89         Eigen::LLT<Eigen::Matrix<T\_e, Eigen::Dynamic, Eigen::Dynamic, Eigen::RowMajor>> llt(cov\_mat);}
\DoxyCodeLine{90         \textcolor{comment}{// generate samples from mvn}}
\DoxyCodeLine{91         tbb::parallel\_for(0, sample\_size\_, [\&](\textcolor{keyword}{auto} p)\{}
\DoxyCodeLine{92             Eigen::Map<Eigen::Matrix<T\_e, 1, T\_dim, Eigen::RowMajor>> sample\_mat(this-\/>candidates\_container\_-\/>\mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_ab608784fc75d08bba940962dfd5761b5}{particle}}(p));}
\DoxyCodeLine{93             sample\_std\_normal(this-\/>candidates\_container\_-\/>\mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_ab608784fc75d08bba940962dfd5761b5}{particle}}(p));}
\DoxyCodeLine{94             sample\_mat = (llt.matrixL() * sample\_mat.transpose()).transpose();}
\DoxyCodeLine{95             sample\_mat.rowwise() += mean\_mat;}
\DoxyCodeLine{96         \}); }
\DoxyCodeLine{97         \textcolor{comment}{// evaluate generated candidates}}
\DoxyCodeLine{98         this-\/>candidates\_container\_-\/>\mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_a8566e2a8a6419f5c5ba60986855b5c0d}{evaluate\_and\_update}}(this-\/>problem\_);}
\DoxyCodeLine{99         \textcolor{comment}{// replace the best candidates in the target container}}
\DoxyCodeLine{100         this-\/>target\_container\_-\/>\mbox{\hyperlink{classrocky_1_1zagros_1_1basic__scontainer_abfd37df0ae67d344d0f0640b196e0f03}{replace\_with}}(this-\/>candidates\_container\_);}
\DoxyCodeLine{101    \}}
\DoxyCodeLine{102 \}; }
\DoxyCodeLine{103 }
\DoxyCodeLine{104 }
\DoxyCodeLine{105 }
\DoxyCodeLine{106 \}; \textcolor{comment}{// end of zagros}}
\DoxyCodeLine{107 \}; \textcolor{comment}{// end of rocky}}
\DoxyCodeLine{108 \textcolor{preprocessor}{\#endif}}

\end{DoxyCode}
